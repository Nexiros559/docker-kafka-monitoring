<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nexiros Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        body { background-color: #1a1a2e; color: #e94560; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #16213e; border: 1px solid #0f3460; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card-header { background-color: #0f3460; color: #fff; font-weight: bold; border-bottom: 1px solid #1a1a2e; }
        .modal-content { background-color: #16213e; color: #fff; border: 2px solid #e94560; }
        .modal-header { border-bottom: 1px solid #e94560; }
        .modal-footer { border-top: 1px solid #e94560; }
    </style>
</head>
<body>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üöÄ Nexiros Dashboard</h1>
        <button onclick="downloadJson()" class="btn btn-success">
            üì• Exporter JSON
        </button>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>üå°Ô∏è CPU Temperature</span>
                    <span id="cpuValue" class="badge bg-danger">-- ¬∞C</span>
                </div>
                <div class="card-body">
                    <canvas id="cpuChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>üß† RAM Utilisation</span>
                    <span id="ramValue" class="badge bg-info">-- Go</span>
                </div>
                <div class="card-body">
                    <canvas id="ramChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">üíæ Espace Disque</div>
                <div class="card-body" style="height: 300px; position: relative;">
                    <canvas id="diskChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">‚ö†Ô∏è ALERTE CRITIQUE SYST√àME</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="alertMessage" class="fs-5">Une anomalie a √©t√© d√©tect√©e.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Compris</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ==========================================
    // ‚öôÔ∏è CONFIGURATION
    // ==========================================
    const LIMIT_CPU_TEMP = 80; // Alerte si > 80¬∞C
    const LIMIT_RAM_USAGE = 14; // Alerte si > 14 Go utilis√©s
    const POINTS_TO_SHOW = 360; // 30 minutes environ

    let alertModalInstance = null;

    async function initDashboard() {
        try {
            const response = await fetch('/api/metrics');
            const fullData = await response.json();

            // On garde les derni√®res donn√©es pour la lisibilit√©
            const data = fullData.slice(-POINTS_TO_SHOW);
            const labels = data.map(d => new Date(d.timestamp));

            // ==========================================
            // 1. GRAPHIQUE CPU (Temp√©rature + Charge)
            // ==========================================
            // CORRECTION : Utilisation de 'cpuLoad'
            const cpuTempData = data.map(d => d.cpu ? d.cpu.temperature : 0);
            const cpuLoadData = data.map(d => d.cpu ? d.cpu.cpuLoad : 0);

            new Chart(document.getElementById('cpuChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temp√©rature (¬∞C)',
                            data: cpuTempData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Charge (%)',
                            data: cpuLoadData,
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 0,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } }, grid: { color: '#2c3e50', tickLength: 0 } },
                        y: { type: 'linear', display: true, position: 'left', grid: { color: '#2c3e50' }, suggestedMin: 30 },
                        y1: { type: 'linear', display: true, position: 'right', min: 0, max: 100, grid: { drawOnChartArea: false } }
                    },
                    plugins: { legend: { display: true, labels: { color: 'white' } } }
                }
            });

            // ==========================================
            // 2. GRAPHIQUE RAM
            // ==========================================
            // CORRECTION : Utilisation de 'used' (pas usedSpace)
            const ramData = data.map(d => d.ram ? (d.ram.used / 1073741824).toFixed(2) : 0);

            new Chart(document.getElementById('ramChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'RAM (Go)',
                        data: ramData,
                        borderColor: '#4ecdc4',
                        backgroundColor: 'rgba(78, 205, 196, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } }, grid: { color: '#2c3e50' } },
                        y: { grid: { color: '#2c3e50' }, min: 0, max: 16 }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // ==========================================
            // 3. GRAPHIQUE DISQUE
            // ==========================================
            const lastRecord = fullData[fullData.length - 1];

            if (lastRecord && lastRecord.disk) {
                // CORRECTION : Utilisation de 'usedSpace' (Comme vu dans ta console disk)
                const usedGo = (lastRecord.disk.usedSpace / 1073741824).toFixed(2);
                const freeGo = (lastRecord.disk.freeSpace / 1073741824).toFixed(2);

                new Chart(document.getElementById('diskChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Utilis√© (Go)', 'Libre (Go)'],
                        datasets: [{
                            data: [usedGo, freeGo],
                            backgroundColor: ['#ffe66d', '#1a535c'],
                            borderColor: '#16213e',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#fff', padding: 20 } }
                        }
                    }
                });
            }

            // ==========================================
            // üö® ALERTE & BADGES
            // ==========================================
            if (lastRecord) {
                // Mise √† jour des badges (Texte en haut √† droite des cartes)
                if(lastRecord.cpu) {
                    document.getElementById('cpuValue').innerText = lastRecord.cpu.temperature + " ¬∞C";
                }

                // CORRECTION : Utilisation de 'used' pour le texte RAM
                if(lastRecord.ram) {
                    document.getElementById('ramValue').innerText = (lastRecord.ram.used / 1073741824).toFixed(1) + " Go";
                }

                // Logique Pop-up
                let alertMsg = "";

                if (lastRecord.cpu && lastRecord.cpu.temperature > LIMIT_CPU_TEMP) {
                    alertMsg += `üî• SURCHAUFFE CPU : ${lastRecord.cpu.temperature}¬∞C<br>`;
                }

                // CORRECTION : Utilisation de 'used' pour le calcul d'alerte RAM
                const currentRamGo = lastRecord.ram ? (lastRecord.ram.used / 1073741824) : 0;
                if (currentRamGo > LIMIT_RAM_USAGE) {
                    alertMsg += `üß† RAM SATUR√âE : ${currentRamGo.toFixed(2)} Go.<br>`;
                }

                if (alertMsg !== "") {
                    const modalElement = document.getElementById('alertModal');
                    const messageElement = document.getElementById('alertMessage');
                    messageElement.innerHTML = alertMsg;
                    alertModalInstance = new bootstrap.Modal(modalElement);
                    alertModalInstance.show();
                }
            }

        } catch (e) {
            console.error("Erreur Application :", e);
        }
    }

    initDashboard();

    // Fonction pour t√©l√©charger le JSON
    async function downloadJson() {
        try {
            // 1. On r√©cup√®re les donn√©es fra√Æches
            const response = await fetch('/api/metrics');
            const data = await response.json();

            // 2. On cr√©e un fichier "virtuel" (Blob) avec le contenu JSON format√©
            const jsonString = JSON.stringify(data, null, 2); // 'null, 2' pour rendre le JSON joli et lisible
            const blob = new Blob([jsonString], { type: "application/json" });

            // 3. On cr√©e un lien invisible pour d√©clencher le t√©l√©chargement
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `metrics_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.json`; // Nom du fichier avec la date

            // 4. On clique dessus programmatiquement et on nettoie
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error("Erreur lors de l'export :", error);
            alert("Erreur lors du t√©l√©chargement des donn√©es !");
        }
    }
</script>

</body>
</html>